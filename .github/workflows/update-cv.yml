name: Update CV

on:
  # Run daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      refresh_cache:
        description: 'Force refresh of Notion cache'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  update-cv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Set up LaTeX
      uses: xu-cheng/latex-action@v2
      with:
        latexmk_use_xelatex: true
        latexmk_use_lualatex: false
        
    - name: Update CV from Notion
      env:
        NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
        DATABASE_ID: ${{ secrets.DATABASE_ID }}
      run: |
        if [ "${{ github.event.inputs.refresh_cache }}" = "true" ]; then
          python update_cv.py --refresh
        else
          python update_cv.py
        fi
        
    - name: Compile LaTeX to PDF
      run: |
        latexmk -pdf cv.tex
        
    - name: Upload PDF artifact
      uses: actions/upload-artifact@v3
      with:
        name: cv-pdf
        path: cv.pdf
        retention-days: 30
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if there are changes to commit
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git add cv.tex cv.pdf
          git commit -m "Auto-update CV from Notion [skip ci]"
          git push
        fi
